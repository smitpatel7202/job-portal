<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Job Portal</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <h2>üíº JobPortal - Admin</h2>
      </div>
      <button class="mobile-menu-btn" onclick="toggleMenu()">‚ò∞</button>
      <div class="nav-links" id="navLinks">
        <a href="admin-dashboard.html">Admin Dashboard</a>
      </div>
    </div>
  </nav>

  <section class="dashboard">
    <div class="container">
      <div class="dashboard-header">
        <h2>üõ°Ô∏è Admin Dashboard</h2>
        <p>Manage platform, verify employers, and moderate jobs</p>
      </div>

      <div id="alert" class="alert"></div>

      <!-- Platform Stats -->
      <div class="dashboard-stats">
        <div class="stat-card">
          <h3 id="totalUsers">0</h3>
          <p>Total Users</p>
        </div>
        <div class="stat-card">
          <h3 id="totalJobs">0</h3>
          <p>Total Jobs</p>
        </div>
        <div class="stat-card">
          <h3 id="pendingJobs">0</h3>
          <p>Pending Jobs</p>
        </div>
        <div class="stat-card">
          <h3 id="totalApplications">0</h3>
          <p>Applications</p>
        </div>
        <div class="stat-card">
          <h3 id="unverifiedEmployers">0</h3>
          <p>Unverified Employers</p>
        </div>
        <div class="stat-card">
          <h3 id="blockedUsers">0</h3>
          <p>Blocked Users</p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="admin-tabs">
        <button class="tab-btn active" onclick="showTab('pending-jobs')">Pending Jobs</button>
        <button class="tab-btn" onclick="showTab('unverified-employers')">Unverified Employers</button>
        <button class="tab-btn" onclick="showTab('all-users')">All Users</button>
        <button class="tab-btn" onclick="showTab('reports')">Job Reports</button>
      </div>

      <!-- Pending Jobs Tab -->
      <div id="pending-jobs" class="tab-content active">
        <div class="dashboard-section">
          <h3>üìã Jobs Awaiting Approval</h3>
          <div id="loadingPendingJobs" class="loading">
            <div class="spinner"></div>
            <p>Loading pending jobs...</p>
          </div>
          <div id="pendingJobsList"></div>
          <div id="emptyPendingJobs" class="empty-state" style="display: none;">
            <h3>No Pending Jobs</h3>
            <p>All jobs have been reviewed!</p>
          </div>
        </div>
      </div>

      <!-- Unverified Employers Tab -->
      <div id="unverified-employers" class="tab-content">
        <div class="dashboard-section">
          <h3>üè¢ Employers Awaiting Verification</h3>
          <div id="loadingEmployers" class="loading">
            <div class="spinner"></div>
            <p>Loading employers...</p>
          </div>
          <div id="employersList"></div>
          <div id="emptyEmployers" class="empty-state" style="display: none;">
            <h3>No Unverified Employers</h3>
            <p>All employers have been verified!</p>
          </div>
        </div>
      </div>

      <!-- All Users Tab -->
      <div id="all-users" class="tab-content">
        <div class="dashboard-section">
          <h3>üë• All Platform Users</h3>
          <div style="margin-bottom: 1rem;">
            <input type="text" id="userSearch" placeholder="Search users..." style="padding: 0.5rem; width: 300px; border: 1px solid #ddd; border-radius: 5px;">
            <select id="userRoleFilter" style="padding: 0.5rem; margin-left: 1rem; border: 1px solid #ddd; border-radius: 5px;">
              <option value="">All Roles</option>
              <option value="jobseeker">Job Seekers</option>
              <option value="employer">Employers</option>
              <option value="admin">Admins</option>
            </select>
            <button class="btn btn-primary btn-small" onclick="loadAllUsers()" style="margin-left: 1rem;">Search</button>
          </div>
          <div id="loadingUsers" class="loading">
            <div class="spinner"></div>
            <p>Loading users...</p>
          </div>
          <div id="usersList"></div>
        </div>
      </div>

      <!-- Reports Tab -->
      <div id="reports" class="tab-content">
        <div class="dashboard-section">
          <h3>üö® Job Reports</h3>
          <div id="loadingReports" class="loading">
            <div class="spinner"></div>
            <p>Loading reports...</p>
          </div>
          <div id="reportsList"></div>
          <div id="emptyReports" class="empty-state" style="display: none;">
            <h3>No Pending Reports</h3>
            <p>All reports have been reviewed!</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 JobPortal. All rights reserved.</p>
    </div>
  </footer>

  <script src="auth.js"></script>
  <script>
    if (!protectRoute(['admin'])) throw new Error('Access denied');

    async function loadStats() {
      try {
        const data = await apiRequest('/admin/stats');
        document.getElementById('totalUsers').textContent = data.totalUsers || 0;
        document.getElementById('totalJobs').textContent = data.totalJobs || 0;
        document.getElementById('pendingJobs').textContent = data.pendingJobs || 0;
        document.getElementById('totalApplications').textContent = data.totalApplications || 0;
        document.getElementById('unverifiedEmployers').textContent = data.unverifiedEmployers || 0;
        if (document.getElementById('blockedUsers')) {
          document.getElementById('blockedUsers').textContent = data.blockedUsers || 0;
        }
      } catch (error) {
        showAlert('Failed to load stats: ' + error.message, 'error');
      }
    }

    async function loadPendingJobs() {
      const loading = document.getElementById('loadingPendingJobs');
      const list = document.getElementById('pendingJobsList');
      const empty = document.getElementById('emptyPendingJobs');

      try {
        const jobs = await apiRequest('/admin/jobs/pending');
        loading.style.display = 'none';

        if (jobs.length === 0) {
          empty.style.display = 'block';
          list.innerHTML = '';
          return;
        }

        empty.style.display = 'none';
        list.innerHTML = jobs.map(job => `
          <div class="admin-review-card">
            <div class="review-header">
              <div>
                <h4>${job.title}</h4>
                <p><strong>Company:</strong> ${job.company}</p>
                <p><strong>Posted by:</strong> ${job.postedBy.name} (${job.postedBy.email})</p>
                <p><strong>Location:</strong> ${job.location} | <strong>Type:</strong> ${job.type}</p>
                <p><strong>Category:</strong> ${job.category}</p>
              </div>
              <span class="status-badge status-pending">${job.status}</span>
            </div>
            
            <div class="review-details">
              <p><strong>Description:</strong></p>
              <p>${job.description}</p>
              
              ${job.requiredSkills && job.requiredSkills.length > 0 ? `
                <p><strong>Required Skills:</strong></p>
                <div class="skills-container">
                  ${job.requiredSkills.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                </div>
              ` : ''}
              
              <p><strong>Experience Level:</strong> ${job.experienceLevel || 'Not specified'}</p>
              <p><strong>Work Mode:</strong> ${job.workMode || 'Not specified'}</p>
              ${job.salary ? `<p><strong>Salary:</strong> ${job.salary}</p>` : ''}
              <p style="color: #7f8c8d; font-size: 0.9rem;">Posted: ${new Date(job.createdAt).toLocaleString()}</p>
            </div>

            <div class="review-actions">
              <button class="btn btn-success btn-small" onclick="approveJob('${job._id}')">
                ‚úÖ Approve Job
              </button>
              <button class="btn btn-danger btn-small" onclick="showRejectForm('${job._id}')">
                ‚ùå Reject Job
              </button>
            </div>

            <div id="reject-form-${job._id}" class="reject-form" style="display: none; margin-top: 1rem;">
              <form onsubmit="rejectJob(event, '${job._id}')">
                <div class="form-group">
                  <label>Reason for rejection:</label>
                  <textarea id="reason-${job._id}" rows="3" placeholder="Explain why this job is rejected..." required></textarea>
                </div>
                <button type="submit" class="btn btn-danger btn-small">Confirm Reject</button>
                <button type="button" class="btn btn-secondary btn-small" onclick="hideRejectForm('${job._id}')">Cancel</button>
              </form>
            </div>
          </div>
        `).join('');
      } catch (error) {
        loading.style.display = 'none';
        showAlert('Failed to load pending jobs: ' + error.message, 'error');
      }
    }

    async function approveJob(jobId) {
      try {
        await apiRequest(`/admin/jobs/${jobId}/review`, {
          method: 'PUT',
          body: JSON.stringify({ status: 'approved' })
        });
        showAlert('Job approved successfully!', 'success');
        loadStats();
        loadPendingJobs();
      } catch (error) {
        showAlert('Failed to approve job: ' + error.message, 'error');
      }
    }

    function showRejectForm(jobId) {
      document.getElementById(`reject-form-${jobId}`).style.display = 'block';
    }

    function hideRejectForm(jobId) {
      document.getElementById(`reject-form-${jobId}`).style.display = 'none';
    }

    async function rejectJob(event, jobId) {
      event.preventDefault();
      const reason = document.getElementById(`reason-${jobId}`).value;

      try {
        await apiRequest(`/admin/jobs/${jobId}/review`, {
          method: 'PUT',
          body: JSON.stringify({ status: 'rejected', rejectionReason: reason })
        });
        showAlert('Job rejected', 'success');
        loadStats();
        loadPendingJobs();
      } catch (error) {
        showAlert('Failed to reject job: ' + error.message, 'error');
      }
    }

    async function loadUnverifiedEmployers() {
      const loading = document.getElementById('loadingEmployers');
      const list = document.getElementById('employersList');
      const empty = document.getElementById('emptyEmployers');

      try {
        const employers = await apiRequest('/admin/employers/unverified');
        loading.style.display = 'none';

        if (employers.length === 0) {
          empty.style.display = 'block';
          list.innerHTML = '';
          return;
        }

        empty.style.display = 'none';
        list.innerHTML = employers.map(emp => `
          <div class="admin-review-card">
            <div class="review-header">
              <div>
                <h4>${emp.name}</h4>
                <p>üìß ${emp.email}</p>
                ${emp.phone ? `<p>üì± ${emp.phone}</p>` : ''}
                ${emp.companyName ? `<p><strong>Company:</strong> ${emp.companyName}</p>` : ''}
                ${emp.companyWebsite ? `<p><strong>Website:</strong> <a href="${emp.companyWebsite}" target="_blank">${emp.companyWebsite}</a></p>` : ''}
                ${emp.industry ? `<p><strong>Industry:</strong> ${emp.industry}</p>` : ''}
                ${emp.companySize ? `<p><strong>Size:</strong> ${emp.companySize}</p>` : ''}
                ${emp.gstNumber ? `<p><strong>GST:</strong> ${emp.gstNumber}</p>` : ''}
              </div>
              <span class="status-badge status-pending">Unverified</span>
            </div>

            ${emp.companyDescription ? `
              <div class="review-details">
                <p><strong>About Company:</strong></p>
                <p>${emp.companyDescription}</p>
              </div>
            ` : ''}

            ${emp.companyLogo ? `
              <div style="margin: 1rem 0;">
                <p><strong>Company Logo:</strong></p>
                <img src="${emp.companyLogo}" alt="Logo" style="max-width: 150px; border-radius: 8px;">
              </div>
            ` : ''}

            <p style="color: #7f8c8d; font-size: 0.9rem;">Registered: ${new Date(emp.createdAt).toLocaleString()}</p>
            <p style="color: #7f8c8d; font-size: 0.9rem;">Profile Completion: ${emp.profileCompletion}%</p>

            <div class="review-actions" style="margin-top: 1rem;">
              <button class="btn btn-success btn-small" onclick="verifyEmployer('${emp._id}')">
                ‚úÖ Verify Employer
              </button>
              <button class="btn btn-danger btn-small" onclick="if(confirm('Block this employer?')) blockUser('${emp._id}')">
                üö´ Block Employer
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        loading.style.display = 'none';
        showAlert('Failed to load employers: ' + error.message, 'error');
      }
    }

    async function verifyEmployer(userId) {
      try {
        await apiRequest(`/admin/employers/${userId}/verify`, {
          method: 'PUT'
        });
        showAlert('Employer verified successfully!', 'success');
        loadStats();
        loadUnverifiedEmployers();
      } catch (error) {
        showAlert('Failed to verify employer: ' + error.message, 'error');
      }
    }

    async function blockUser(userId, block = true) {
      try {
        await apiRequest(`/admin/users/${userId}/block`, {
          method: 'PUT',
          body: JSON.stringify({ blocked: block })
        });
        showAlert(`User ${block ? 'blocked' : 'unblocked'} successfully`, 'success');
        loadStats();
        loadAllUsers();
        loadUnverifiedEmployers();
      } catch (error) {
        showAlert('Failed to update user: ' + error.message, 'error');
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
      
      try {
        await apiRequest(`/admin/users/${userId}`, {
          method: 'DELETE'
        });
        showAlert('User deleted successfully', 'success');
        loadStats();
        loadAllUsers();
      } catch (error) {
        showAlert('Failed to delete user: ' + error.message, 'error');
      }
    }

    async function loadAllUsers() {
      const loading = document.getElementById('loadingUsers');
      const list = document.getElementById('usersList');
      const search = document.getElementById('userSearch')?.value || '';
      const roleFilter = document.getElementById('userRoleFilter')?.value || '';

      try {
        let url = '/admin/users?';
        if (search) url += `search=${encodeURIComponent(search)}&`;
        if (roleFilter) url += `role=${roleFilter}&`;
        
        const users = await apiRequest(url);
        loading.style.display = 'none';

        if (users.length === 0) {
          list.innerHTML = '<p style="text-align: center; padding: 2rem;">No users found</p>';
          return;
        }

        list.innerHTML = `
          <table class="admin-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Verified</th>
                <th>Blocked</th>
                <th>Profile %</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(user => `
                <tr>
                  <td>${user.name}</td>
                  <td>${user.email}</td>
                  <td><span class="role-badge role-${user.role}">${user.role}</span></td>
                  <td>${user.isVerified ? '‚úÖ' : '‚ùå'}</td>
                  <td>${user.isBlocked ? 'üö´ Yes' : '‚úÖ No'}</td>
                  <td>${user.profileCompletion || 0}%</td>
                  <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                  <td style="white-space: nowrap;">
                    ${!user.isVerified && user.role === 'employer' ? 
                      `<button class="btn btn-success btn-small" onclick="verifyEmployer('${user._id}')" style="margin-right: 5px;">Verify</button>` : ''}
                    ${user.isBlocked ? 
                      `<button class="btn btn-primary btn-small" onclick="blockUser('${user._id}', false)" style="margin-right: 5px;">Unblock</button>` :
                      user.role !== 'admin' ? `<button class="btn btn-warning btn-small" onclick="blockUser('${user._id}', true)" style="margin-right: 5px;">Block</button>` : ''}
                    ${user.role !== 'admin' ? 
                      `<button class="btn btn-danger btn-small" onclick="deleteUser('${user._id}')">Delete</button>` : ''}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        loading.style.display = 'none';
        showAlert('Failed to load users: ' + error.message, 'error');
      }
    }

    async function loadReports() {
      const loading = document.getElementById('loadingReports');
      const list = document.getElementById('reportsList');
      const empty = document.getElementById('emptyReports');

      try {
        const reports = await apiRequest('/admin/reports');
        loading.style.display = 'none';

        if (reports.length === 0) {
          empty.style.display = 'block';
          list.innerHTML = '';
          return;
        }

        empty.style.display = 'none';
        list.innerHTML = reports.map(report => `
          <div class="admin-review-card">
            <div class="review-header">
              <div>
                <h4>Reported Job: ${report.jobId.title}</h4>
                <p><strong>Company:</strong> ${report.jobId.company}</p>
                <p><strong>Reported by:</strong> ${report.reportedBy.name} (${report.reportedBy.email})</p>
                <p><strong>Reason:</strong> ${report.reason}</p>
                ${report.description ? `<p><strong>Description:</strong> ${report.description}</p>` : ''}
                <p style="color: #7f8c8d; font-size: 0.9rem;">Reported: ${new Date(report.createdAt).toLocaleString()}</p>
              </div>
              <span class="status-badge status-pending">Pending Review</span>
            </div>
            <div class="review-actions" style="margin-top: 1rem;">
              <button class="btn btn-danger btn-small" onclick="reviewReport('${report._id}', 'resolved', 'block_job')">
                Block Job
              </button>
              <button class="btn btn-danger btn-small" onclick="reviewReport('${report._id}', 'resolved', 'block_employer')">
                Block Employer
              </button>
              <button class="btn btn-secondary btn-small" onclick="reviewReport('${report._id}', 'dismissed', 'dismiss')">
                Dismiss Report
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        loading.style.display = 'none';
        showAlert('Failed to load reports: ' + error.message, 'error');
      }
    }

    async function reviewReport(reportId, status, action) {
      if (!confirm(`Are you sure you want to ${action === 'block_job' ? 'block this job' : action === 'block_employer' ? 'block this employer' : 'dismiss this report'}?`)) return;

      try {
        await apiRequest(`/admin/reports/${reportId}/review`, {
          method: 'PUT',
          body: JSON.stringify({ status, action })
        });
        showAlert('Report reviewed successfully', 'success');
        loadReports();
      } catch (error) {
        showAlert('Failed to review report: ' + error.message, 'error');
      }
    }

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      // Load data for the tab
      if (tabName === 'pending-jobs') {
        loadPendingJobs();
      } else if (tabName === 'unverified-employers') {
        loadUnverifiedEmployers();
      } else if (tabName === 'all-users') {
        loadAllUsers();
      } else if (tabName === 'reports') {
        loadReports();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadPendingJobs();
    });
  </script>

  <style>
    .admin-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
    }

    .tab-btn {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: #7f8c8d;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab-btn:hover {
      color: #3498db;
    }

    .tab-btn.active {
      color: #3498db;
      border-bottom-color: #3498db;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .admin-review-card {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 4px solid #3498db;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .review-header h4 {
      color: #2c3e50;
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }

    .review-details {
      margin: 1.5rem 0;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .review-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .reject-form {
      background: #fff3cd;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #ffc107;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .admin-table th,
    .admin-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .admin-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
    }

    .admin-table tbody tr:hover {
      background: #f8f9fa;
    }

    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: capitalize;
    }

    .role-jobseeker {
      background: #e3f2fd;
      color: #1976d2;
    }

    .role-employer {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .role-admin {
      background: #fce4ec;
      color: #c2185b;
    }

    @media (max-width: 768px) {
      .admin-table {
        font-size: 0.9rem;
      }

      .admin-table th,
      .admin-table td {
        padding: 8px;
      }
    }
  </style>
</body>
</html>